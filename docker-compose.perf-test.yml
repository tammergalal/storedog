# Performance test compose — no Datadog agent, production builds
# Usage: docker compose -f docker-compose.perf-test.yml up -d --build
# All services run without the DD agent; tracing is disabled to isolate pure app performance.

services:
  frontend:
    build:
      context: ./services/frontend
    # build/server/index.js is the Remix app manifest — must be served via remix-serve (not node directly)
    # Skip --require ./datadog-tracer.js: package.json "type":"module" makes it ESM-incompatible
    command: ["node", "./node_modules/@remix-run/serve/dist/cli.js", "./build/server/index.js"]
    # No volume mounts — full production image build
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000/', r => r.statusCode < 500 ? process.exit(0) : process.exit(1)).on('error', () => process.exit(1))"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 60s
    restart: always
    depends_on:
      store-catalog:
        condition: service_healthy
      store-cart:
        condition: service_healthy
    networks:
      - storedog-network
    environment:
      - DD_TRACE_ENABLED=false
      - DD_ENV=production
      - DD_SERVICE=store-frontend-api
      - DD_VERSION=1.0.0
      - DD_RUNTIME_METRICS_ENABLED=false
      - DD_PROFILING_ENABLED=false
      - NEXT_PUBLIC_ADS_ROUTE=/services/ads
      - NEXT_PUBLIC_DISCOUNTS_ROUTE=/services/discounts
      - NEXT_PUBLIC_DBM_ROUTE=/services/dbm
      - NEXT_PUBLIC_FRONTEND_API_ROUTE=http://service-proxy:80
      - CATALOG_API_HOST=http://service-proxy/services/catalog
      - CART_API_HOST=http://service-proxy/services/cart
      - FEATURE_FLAG_ADS_ENABLED=true
      - FEATURE_FLAG_DISCOUNTS_ENABLED=true
      - SERVICE_ERROR_RATE=0.0
      - SERVICE_DELAY_MS=0

  store-catalog:
    build:
      context: ./services/catalog
    # Wait for postgres TCP, then poll until the 'storedog_db' DB is created by initdb.d restore
    command:
      - /bin/bash
      - -c
      - |
        wait-for-it postgres:5432 --timeout=60
        until python -c "import psycopg2; psycopg2.connect(host='postgres',user='postgres',password='postgres',dbname='storedog_db').close()" 2>/dev/null; do
          echo "Waiting for storedog_db database..."
          sleep 2
        done
        exec ddtrace-run uvicorn main:app --host 0.0.0.0 --port 8000
    restart: on-failure
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - storedog-network
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/storedog_db
      - DD_TRACE_ENABLED=false
      - DD_ENV=production
      - DD_SERVICE=store-catalog
      - DD_VERSION=1.0.0
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  store-cart:
    build:
      context: ./services/cart
    command:
      - /bin/bash
      - -c
      - |
        wait-for-it postgres:5432 --timeout=60
        until python -c "import psycopg2; psycopg2.connect(host='postgres',user='postgres',password='postgres',dbname='storedog_db').close()" 2>/dev/null; do
          echo "Waiting for storedog_db database..."
          sleep 2
        done
        exec ddtrace-run uvicorn main:app --host 0.0.0.0 --port 8001
    restart: on-failure
    depends_on:
      postgres:
        condition: service_healthy
      store-catalog:
        condition: service_healthy
      discounts:
        condition: service_healthy
    networks:
      - storedog-network
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD:-postgres}@postgres:5432/storedog_db
      - CATALOG_URL=http://store-catalog:8000
      - DISCOUNTS_URL=http://discounts:2814
      - DD_TRACE_ENABLED=false
      - DD_ENV=production
      - DD_SERVICE=store-cart
      - DD_VERSION=1.0.0
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  discounts:
    build:
      context: ./services/discounts
    command: wait-for-it postgres:5432 -- flask run --port=2814 --host=0.0.0.0
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_HOST=postgres
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - DD_TRACE_ENABLED=false
      - DD_ENV=production
      - DD_SERVICE=store-discounts
      - DD_VERSION=1.0.0
    volumes:
      - ./services/discounts:/app
    networks:
      - storedog-network
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:2814/discount')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  ads:
    build:
      context: ./services/ads/java
    restart: on-failure
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      - DD_TRACE_ENABLED=false
      - DD_ENV=production
      - DD_SERVICE=store-ads
      - DD_VERSION=1.0.0
    networks:
      - storedog-network
    healthcheck:
      test: ["CMD", "sh", "-c", "exec 3<>/dev/tcp/localhost/3030 && echo -e 'GET /health HTTP/1.0\r\n\r\n' >&3 && cat <&3 | grep -q HTTP"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  service-proxy:
    build:
      context: ./services/nginx
    restart: always
    ports:
      - '80:80'
    networks:
      - storedog-network
    depends_on:
      - frontend
      - store-catalog
      - store-cart
      - ads
    environment:
      - DD_TRACE_ENABLED=false
      - DD_SERVICE=service-proxy
      - DD_VERSION=1.0.0

  postgres:
    build:
      context: ./services/postgres
    healthcheck:
      test: ["CMD", "pg_isready", "-U", "${POSTGRES_USER:-postgres}"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 20s
    restart: always
    volumes:
      - postgres_logs:/var/log/pg_log:rw
    networks:
      - storedog-network
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-postgres}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-postgres}

  redis:
    image: redis:6.2-alpine
    healthcheck:
      test: ['CMD', 'redis-cli', '--raw', 'incr', 'ping']
      interval: 3s
    volumes:
      - 'redis:/data'
    networks:
      - storedog-network

volumes:
  redis:
  postgres_logs:

networks:
  storedog-network:
